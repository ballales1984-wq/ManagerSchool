{% extends "base.html" %}

{% block title %}Inserimento Rapido Voti - ManagerSchool{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-lightning-charge-fill"></i> Inserimento Rapido Voti</h2>
        <p class="text-muted">Inserisci voti in modo veloce con l'interfaccia semplificata</p>
    </div>
</div>

<div class="row">
    <!-- Interfaccia principale -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-grid-3x3"></i> Selezione Rapida</h5>
            </div>
            <div class="card-body">
                <!-- Selezione Materia -->
                <div class="mb-4">
                    <label class="form-label"><strong>üìö Materia:</strong></label>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-primary btn-lg" onclick="setMateria('Matematica')" id="btn-matematica">
                            üìò Matematica
                        </button>
                        <button class="btn btn-outline-primary btn-lg" onclick="setMateria('Italiano')" id="btn-italiano">
                            üìó Italiano
                        </button>
                        <button class="btn btn-outline-primary btn-lg" onclick="setMateria('Inglese')" id="btn-inglese">
                            üìï Inglese
                        </button>
                        <button class="btn btn-outline-primary btn-lg" onclick="setMateria('Storia')" id="btn-storia">
                            üìú Storia
                        </button>
                        <button class="btn btn-outline-primary btn-lg" onclick="setMateria('Educazione Fisica')" id="btn-edfisica">
                            ‚öΩ Educazione Fisica
                        </button>
                        <button class="btn btn-outline-primary btn-lg" onclick="setMateria('Religione')" id="btn-religione">
                            ‚úùÔ∏è Religione
                        </button>
                    </div>
                </div>

                <!-- Selezione Tipo -->
                <div class="mb-4">
                    <label class="form-label"><strong>üìù Tipo di Prova:</strong></label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-warning btn-lg" onclick="setTipo('interrogazione')" id="btn-interroga">
                            üü° Interrogazione
                        </button>
                        <button class="btn btn-danger btn-lg" onclick="setTipo('verifica scritta')" id="btn-verifica">
                            üî¥ Verifica
                        </button>
                    </div>
                </div>

                <!-- Input dati -->
                <div class="mb-3">
                    <label for="studente" class="form-label"><strong>üë§ Studente:</strong></label>
                    <input type="text" class="form-control form-control-lg" id="studente" 
                           placeholder="Nome studente" autocomplete="off" onkeyup="cercaStudenti(this.value)">
                    <div id="suggerimenti" class="list-group mt-2" style="display:none;"></div>
                </div>

                <div class="mb-3">
                    <label for="voto" class="form-label"><strong>‚≠ê Voto:</strong></label>
                    <input type="number" class="form-control form-control-lg" id="voto" 
                           min="1" max="10" step="0.5" placeholder="Es. 8">
                </div>

                <button class="btn btn-success btn-lg w-100" onclick="registraVoce()" id="btn-registra">
                    <i class="bi bi-check-circle"></i> Registra Voto
                </button>

                <!-- Conferma -->
                <div id="conferma" class="mt-3 alert" style="display:none;"></div>
            </div>
        </div>
    </div>

    <!-- Pannello info -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Info</h5>
            </div>
            <div class="card-body">
                <p><strong>Materia selezionata:</strong> <span id="info-materia" class="text-muted">Nessuna</span></p>
                <p><strong>Tipo selezionato:</strong> <span id="info-tipo" class="text-muted">Nessuno</span></p>
                <hr>
                <h6><i class="bi bi-keyboard"></i> Guida Rapida:</h6>
                <small>
                    <ol>
                        <li>Clicca sulla materia</li>
                        <li>Scegli il tipo di prova</li>
                        <li>Inserisci nome studente</li>
                        <li>Inserisci il voto</li>
                        <li>Clicca "Registra Voto"</li>
                    </ol>
                </small>
            </div>
        </div>

        <!-- Cronologia ultimi inserimenti -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-clock-history"></i> Ultimi Inserimenti</h6>
            </div>
            <div class="card-body">
                <div id="cronologia" class="list-group list-group-flush">
                    <p class="text-muted small">Nessun inserimento recente</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let materia = "";
let tipo = "";

function setMateria(m) {
    materia = m;
    // Aggiorna UI
    document.querySelectorAll('[id^="btn-"]').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
    });
    document.getElementById(`btn-${m.toLowerCase().replace(' ', '-')}`).classList.replace('btn-outline-primary', 'btn-primary');
    
    // Aggiorna info
    document.getElementById('info-materia').textContent = m;
    document.getElementById('info-materia').classList.remove('text-muted');
}

function setTipo(t) {
    tipo = t;
    // Aggiorna UI
    document.getElementById('btn-interroga').classList.toggle('btn-warning', t === 'interrogazione');
    document.getElementById('btn-interroga').classList.toggle('btn-outline-warning', t !== 'interrogazione');
    document.getElementById('btn-verifica').classList.toggle('btn-danger', t === 'verifica scritta');
    document.getElementById('btn-verifica').classList.toggle('btn-outline-danger', t !== 'verifica scritta');
    
    // Aggiorna info
    document.getElementById('info-tipo').textContent = t;
    document.getElementById('info-tipo').classList.remove('text-muted');
}

function cercaStudenti(query) {
    if (query.length < 2) {
        document.getElementById('suggerimenti').style.display = 'none';
        return;
    }
    
    fetch(`/api/studenti/search?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(studenti => {
            const container = document.getElementById('suggerimenti');
            if (studenti.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.innerHTML = studenti.map(s => 
                `<a href="#" class="list-group-item list-group-item-action" 
                    onclick="event.preventDefault(); selectStudente('${s.nome}');">
                    ${s.nome} <small class="text-muted">(${s.classe})</small>
                </a>`
            ).join('');
            container.style.display = 'block';
        });
}

function selectStudente(nome) {
    document.getElementById('studente').value = nome;
    document.getElementById('suggerimenti').style.display = 'none';
}

async function registraVoce() {
    const studente = document.getElementById('studente').value.trim();
    const voto = document.getElementById('voto').value;
    
    if (!materia || !tipo || !studente || !voto) {
        showConferma('Compila tutti i campi!', 'warning');
        return;
    }
    
    const btn = document.getElementById('btn-registra');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Registrando...';
    
    // Crea la frase
    const frase = `${materia} ${tipo} allunno ${studente} voto ${voto}`;
    
    try {
        const response = await fetch('/api/inserimento-rapido/voto', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ frase: frase })
        });
        
        const data = await response.json();
        
        if (data.successo) {
            showConferma(data.messaggio, 'success');
            // Reset form
            document.getElementById('studente').value = '';
            document.getElementById('voto').value = '';
            materia = '';
            tipo = '';
            document.getElementById('info-materia').textContent = 'Nessuna';
            document.getElementById('info-materia').classList.add('text-muted');
            document.getElementById('info-tipo').textContent = 'Nessuno';
            document.getElementById('info-tipo').classList.add('text-muted');
            
            // Carica cronologia
            caricaCronologia();
        } else {
            showConferma(data.errore || 'Errore nell\'inserimento', 'danger');
        }
    } catch (error) {
        console.error('Errore:', error);
        showConferma('Errore di comunicazione con il server', 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Registra Voto';
    }
}

function showConferma(messaggio, tipo) {
    const div = document.getElementById('conferma');
    div.className = `mt-3 alert alert-${tipo}`;
    div.textContent = messaggio;
    div.style.display = 'block';
    
    setTimeout(() => {
        div.style.display = 'none';
    }, 3000);
}

function caricaCronologia() {
    fetch('/api/inserimento-rapido/cronologia')
        .then(res => res.json())
        .then(voci => {
            const container = document.getElementById('cronologia');
            if (voci.length === 0) {
                container.innerHTML = '<p class="text-muted small">Nessun inserimento recente</p>';
                return;
            }
            
            container.innerHTML = voci.slice(0, 5).map(v => `
                <div class="list-group-item">
                    <small><strong>${v.materia}</strong> ${v.tipo}</small><br>
                    <small>${v.studente} - Voto: ${v.voto}</small><br>
                    <small class="text-muted">${v.ora}</small>
                </div>
            `).join('');
        });
}

// Carica cronologia all'avvio
document.addEventListener('DOMContentLoaded', caricaCronologia);
</script>
{% endblock %}

